---
- name: iptables | Create /etc/iptables
  ansible.builtin.file:
    path: /etc/iptables
    state: directory
    mode: "0755"

- name: iptables | Copy ipv4 rules file
  ansible.builtin.copy:
    src: files/iptables/rules.v4
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: "0644"
    backup: true

- name: iptables | Copy ipv6 rules file
  ansible.builtin.copy:
    src: files/iptables/rules.v6
    dest: /etc/iptables/rules.v6
    owner: root
    group: root
    mode: "0644"
    backup: true

- name: iptables | Apply ipv4 iptables rules
  community.general.iptables_state:
    state: restored
    path: /etc/iptables/rules.v4
  async: "{{ ansible_timeout }}"
  poll: 0
  when: not ansible_check_mode
  notify:
    - Restart Docker

- name: iptables | Apply ipv6 iptables rules
  community.general.iptables_state:
    state: restored
    path: /etc/iptables/rules.v6
    ip_version: ipv6
  async: "{{ ansible_timeout }}"
  poll: 0
  when: not ansible_check_mode
  notify:
    - Restart Docker
